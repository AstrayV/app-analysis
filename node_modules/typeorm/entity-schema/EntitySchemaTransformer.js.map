{"version":3,"sources":["../../src/entity-schema/EntitySchemaTransformer.ts"],"names":[],"mappings":"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","file":"EntitySchemaTransformer.js","sourcesContent":["import {EntitySchema} from \"./EntitySchema\";\nimport {MetadataArgsStorage} from \"../metadata-args/MetadataArgsStorage\";\nimport {TableMetadataArgs} from \"../metadata-args/TableMetadataArgs\";\nimport {ColumnMetadataArgs} from \"../metadata-args/ColumnMetadataArgs\";\nimport {IndexMetadataArgs} from \"../metadata-args/IndexMetadataArgs\";\nimport {RelationMetadataArgs} from \"../metadata-args/RelationMetadataArgs\";\nimport {JoinColumnMetadataArgs} from \"../metadata-args/JoinColumnMetadataArgs\";\nimport {JoinTableMetadataArgs} from \"../metadata-args/JoinTableMetadataArgs\";\nimport {JoinTableOptions} from \"../decorator/options/JoinTableOptions\";\nimport {JoinTableMultipleColumnsOptions} from \"../decorator/options/JoinTableMuplipleColumnsOptions\";\nimport {ColumnMode} from \"../metadata-args/types/ColumnMode\";\nimport {GeneratedMetadataArgs} from \"../metadata-args/GeneratedMetadataArgs\";\n\n/**\n * Transforms entity schema into metadata args storage.\n * The result will be just like entities read from decorators.\n */\nexport class EntitySchemaTransformer {\n\n    // -------------------------------------------------------------------------\n    // Public Methods\n    // -------------------------------------------------------------------------\n\n    /**\n     * Transforms entity schema into new metadata args storage object.\n     */\n    transform(schemas: EntitySchema[]): MetadataArgsStorage {\n        const metadataArgsStorage = new MetadataArgsStorage();\n\n        schemas.forEach(schema => {\n\n            // add table metadata args from the schema\n            const table = schema.table || {} as any;\n            const tableMetadata: TableMetadataArgs = {\n                target: schema.target || schema.name,\n                name: table.name,\n                type: table.type || \"regular\",\n                orderBy: table.orderBy\n            };\n            metadataArgsStorage.tables.push(tableMetadata);\n\n            // add columns metadata args from the schema\n            Object.keys(schema.columns).forEach(columnName => {\n                const tableColumn = schema.columns[columnName];\n                let mode: ColumnMode = \"regular\";\n                if (tableColumn.createDate)\n                    mode = \"createDate\";\n                if (tableColumn.updateDate)\n                    mode = \"updateDate\";\n                if (tableColumn.version)\n                    mode = \"version\";\n                if (tableColumn.treeChildrenCount)\n                    mode = \"treeChildrenCount\";\n                if (tableColumn.treeLevel)\n                    mode = \"treeLevel\";\n\n                const columnAgrs: ColumnMetadataArgs = {\n                    target: schema.target || schema.name,\n                    mode: mode,\n                    propertyName: columnName,\n                    options: {\n                        type: tableColumn.type,\n                        name: tableColumn.name,\n                        length: tableColumn.length,\n                        primary: tableColumn.primary,\n                        unique: tableColumn.unique,\n                        nullable: tableColumn.nullable,\n                        comment: tableColumn.comment,\n                        default: tableColumn.default,\n                        precision: tableColumn.precision,\n                        scale: tableColumn.scale\n                    }\n                };\n                metadataArgsStorage.columns.push(columnAgrs);\n\n                if (tableColumn.generated) {\n                    const generationArgs: GeneratedMetadataArgs = {\n                        target: schema.target || schema.name,\n                        propertyName: columnName,\n                        strategy: typeof tableColumn.generated === \"string\" ? tableColumn.generated : \"increment\"\n                    };\n                    metadataArgsStorage.generations.push(generationArgs);\n                }\n            });\n\n            // add relation metadata args from the schema\n            if (schema.relations) {\n                Object.keys(schema.relations).forEach(relationName => {\n                    const relationSchema = schema.relations![relationName];\n                    const relation: RelationMetadataArgs = {\n                        target: schema.target || schema.name,\n                        propertyName: relationName,\n                        relationType: relationSchema.type,\n                        isLazy: relationSchema.isLazy || false,\n                        type: relationSchema.target,\n                        inverseSideProperty: relationSchema.inverseSide,\n                        isTreeParent: relationSchema.isTreeParent,\n                        isTreeChildren: relationSchema.isTreeChildren,\n                        options: {\n                            cascadeAll: relationSchema.cascadeAll,\n                            cascadeInsert: relationSchema.cascadeInsert,\n                            cascadeUpdate: relationSchema.cascadeUpdate,\n                            cascadeRemove: relationSchema.cascadeRemove,\n                            nullable: relationSchema.nullable,\n                            onDelete: relationSchema.onDelete\n                        }\n                    };\n\n                    metadataArgsStorage.relations.push(relation);\n\n                    // add join column\n                    if (relationSchema.joinColumn) {\n                        if (typeof relationSchema.joinColumn === \"boolean\") {\n                            const joinColumn: JoinColumnMetadataArgs = {\n                                target: schema.target || schema.name,\n                                propertyName: relationName\n                            };\n                            metadataArgsStorage.joinColumns.push(joinColumn);\n                        } else {\n                            const joinColumn: JoinColumnMetadataArgs = {\n                                target: schema.target || schema.name,\n                                propertyName: relationName,\n                                name: relationSchema.joinColumn.name,\n                                referencedColumnName: relationSchema.joinColumn.referencedColumnName\n                            };\n                            metadataArgsStorage.joinColumns.push(joinColumn);\n                        }\n                    }\n\n                    // add join table\n                    if (relationSchema.joinTable) {\n                        if (typeof relationSchema.joinTable === \"boolean\") {\n                            const joinTable: JoinTableMetadataArgs = {\n                                target: schema.target || schema.name,\n                                propertyName: relationName\n                            };\n                            metadataArgsStorage.joinTables.push(joinTable);\n                        } else {\n                            const joinTable: JoinTableMetadataArgs = {\n                                target: schema.target || schema.name,\n                                propertyName: relationName,\n                                name: relationSchema.joinTable.name,\n                                joinColumns: ((relationSchema.joinTable as JoinTableOptions).joinColumn ? [(relationSchema.joinTable as JoinTableOptions).joinColumn!] : (relationSchema.joinTable as JoinTableMultipleColumnsOptions).joinColumns) as any,\n                                inverseJoinColumns: ((relationSchema.joinTable as JoinTableOptions).inverseJoinColumn ? [(relationSchema.joinTable as JoinTableOptions).inverseJoinColumn!] : (relationSchema.joinTable as JoinTableMultipleColumnsOptions).inverseJoinColumns) as any,\n                            };\n                            metadataArgsStorage.joinTables.push(joinTable);\n                        }\n                    }\n                });\n            }\n\n            // add relation metadata args from the schema\n            if (schema.indices) {\n                Object.keys(schema.indices).forEach(indexName => {\n                    const tableIndex = schema.indices![indexName];\n                    const indexAgrs: IndexMetadataArgs = {\n                        target: schema.target || schema.name,\n                        name: indexName,\n                        unique: tableIndex.unique,\n                        sparse: tableIndex.sparse,\n                        columns: tableIndex.columns\n                    };\n                    metadataArgsStorage.indices.push(indexAgrs);                        \n                });\n            }    \n\n        });\n\n        return metadataArgsStorage;\n    }\n}"],"sourceRoot":".."}